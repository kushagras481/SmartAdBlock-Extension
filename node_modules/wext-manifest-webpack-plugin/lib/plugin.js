"use strict";
/* eslint-disable import/no-extraneous-dependencies */
Object.defineProperty(exports, "__esModule", { value: true });
exports.WextManifestWebpackPlugin = void 0;
/**
 *  wext-manifest-webpack-plugin
 *
 *  @author   abhijithvijayan <abhijithvijayan.in>
 *  @license  MIT License
 */
require("emoji-log");
const PLUGIN_NAME = 'wext-manifest-webpack-plugin';
function getEntryResource(module) {
    const resource = null;
    if (module && typeof module.resource === 'string') {
        return module.resource;
    }
    return resource;
}
class WextManifestWebpackPlugin {
    // Define `apply` as its prototype method which is supplied with compiler as its argument
    apply(compiler) {
        /**
         *  webpack 4+ comes with a new plugin system.
         *
         *  (// ToDo: support old plugin system //)
         */
        const { hooks } = compiler;
        // Check for hooks for 4+
        if (hooks) {
            // Runs plugin after a compilation has been created.
            hooks.compilation.tap(PLUGIN_NAME, (compilation) => {
                // Triggered when an asset from a chunk was added to the compilation.
                compilation.hooks.chunkAsset.tap(PLUGIN_NAME, (chunk, file) => {
                    // Only handle js files with entry modules
                    if (!file.endsWith('.js') || !chunk.hasEntryModule()) {
                        return;
                    }
                    // Returns path containing name of asset
                    const resource = getEntryResource(chunk.entryModule);
                    const isManifest = (resource && /manifest\.json$/.test(resource)) || false;
                    if (isManifest) {
                        chunk.files = chunk.files.filter((f) => {
                            return f !== file;
                        });
                        delete compilation.assets[file];
                        // https://github.com/abhijithvijayan/wext-manifest-webpack-plugin/issues/1
                        // console.emoji('ðŸ¦„', `${PLUGIN_NAME}: removed ${file}`, 29);
                        console.log(`${PLUGIN_NAME}: removed ${file}`);
                    }
                });
            });
        }
    }
}
exports.WextManifestWebpackPlugin = WextManifestWebpackPlugin;
